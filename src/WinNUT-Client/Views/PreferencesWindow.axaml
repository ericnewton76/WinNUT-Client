<Window xmlns="https://github.com/avaloniaui"
				xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
				xmlns:vm="using:WinNUT_Client.ViewModels"
				xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
				xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
				mc:Ignorable="d" d:DesignWidth="600" d:DesignHeight="600"
				x:Class="WinNUT_Client.Views.PreferencesWindow"
				x:DataType="vm:PreferencesViewModel"
				Icon="/Assets/WinNut.ico"
				Title="Preferences"
				Width="600" Height="600"
				MinWidth="550" MinHeight="550"
				WindowStartupLocation="CenterOwner"
				CanResize="False">

	<Design.DataContext>
		<vm:PreferencesViewModel/>
	</Design.DataContext>

	<DockPanel Margin="10">
		<!-- Buttons at bottom -->
		<StackPanel DockPanel.Dock="Bottom" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="10" Margin="0,10,0,0">
			<Button Content="Save" Command="{Binding SaveCommand}" Width="80" />
			<Button Content="Cancel" Command="{Binding CancelCommand}" Width="80" />
		</StackPanel>

		<!-- Tab Control -->
		<TabControl>
			<!-- UPS Devices Tab -->
			<TabItem Header="UPS Devices">
				<Grid RowDefinitions="140,Auto,*" Margin="10">
					<!-- Device List -->
					<Border Grid.Row="0" BorderBrush="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
									BorderThickness="1" CornerRadius="4" Margin="0,0,0,10">
						<ListBox ItemsSource="{Binding UpsDevices}" 
										 SelectedItem="{Binding SelectedUpsDevice}"
										 SelectionMode="Single">
							<ListBox.ItemTemplate>
								<DataTemplate DataType="vm:UpsDeviceViewModel">
									<Grid ColumnDefinitions="*,Auto" Margin="5,3">
										<StackPanel Grid.Column="0">
											<TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
											<TextBlock Text="{Binding HostDisplay}" FontSize="11" 
																 Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" />
										</StackPanel>
										<StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="5" VerticalAlignment="Center">
											<TextBlock Text="Primary" FontSize="10" Foreground="Orange" 
																 IsVisible="{Binding IsPrimary}" VerticalAlignment="Center" />
											<CheckBox IsChecked="{Binding Enabled}" ToolTip.Tip="Enabled" />
										</StackPanel>
									</Grid>
								</DataTemplate>
							</ListBox.ItemTemplate>
						</ListBox>
					</Border>

					<!-- List Buttons -->
					<StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="5" Margin="0,0,0,10">
						<Button Content="Add" Command="{Binding AddUpsCommand}"  />
						<Button Content="Remove" Command="{Binding RemoveUpsCommand}"  
										IsEnabled="{Binding SelectedUpsDevice, Converter={x:Static ObjectConverters.IsNotNull}}" />
						<Button Content="Set Primary" Command="{Binding SetPrimaryUpsCommand}" 
										IsEnabled="{Binding SelectedUpsDevice, Converter={x:Static ObjectConverters.IsNotNull}}" />
					</StackPanel>

					<!-- Editor Panel (visible when device selected) -->
					<Border Grid.Row="2" Background="{DynamicResource SystemControlBackgroundChromeMediumLowBrush}" 
									CornerRadius="5" Padding="15"
									IsVisible="{Binding SelectedUpsDevice, Converter={x:Static ObjectConverters.IsNotNull}}">
						<Grid ColumnDefinitions="120,*" RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto" RowSpacing="8">
							<TextBlock Grid.Row="0" Grid.Column="0" Text="Display Name:" VerticalAlignment="Center" />
							<TextBox Grid.Row="0" Grid.Column="1" Text="{Binding SelectedUpsDevice.DisplayName}" />

							<TextBlock Grid.Row="1" Grid.Column="0" Text="UPS Address:" VerticalAlignment="Center" />
							<TextBox Grid.Row="1" Grid.Column="1" Text="{Binding SelectedUpsDevice.Address}" 
											 Watermark="upsname@host:port (port defaults to 3493)" />

							<TextBlock Grid.Row="2" Grid.Column="0" Text="Poll Interval (s):" VerticalAlignment="Center" />
							<NumericUpDown Grid.Row="2" Grid.Column="1" Value="{Binding SelectedUpsDevice.PollingInterval}" 
														 Minimum="1" Maximum="60" Width="120" HorizontalAlignment="Left" />

							<TextBlock Grid.Row="3" Grid.Column="0" Text="Login:" VerticalAlignment="Center" />
							<TextBox Grid.Row="3" Grid.Column="1" Text="{Binding SelectedUpsDevice.Login}" />

							<TextBlock Grid.Row="4" Grid.Column="0" Text="Password:" VerticalAlignment="Center" />
							<TextBox Grid.Row="4" Grid.Column="1" Text="{Binding SelectedUpsDevice.Password}" PasswordChar="â—" />

							<StackPanel Grid.Row="5" Grid.Column="1" Orientation="Horizontal" Spacing="15">
								<CheckBox Content="Auto Reconnect" IsChecked="{Binding SelectedUpsDevice.AutoReconnect}" />
								<CheckBox Content="Connect on startup" IsChecked="{Binding SelectedUpsDevice.AutoConnectOnStartup}" />
							</StackPanel>
						</Grid>
					</Border>
				</Grid>
			</TabItem>

			<!-- Multi-UPS Settings Tab -->
			<TabItem Header="Multi-UPS">
				<StackPanel Margin="10" Spacing="15">
					<TextBlock Text="Shutdown Behavior" FontWeight="Bold" />
					<TextBlock Text="When should WinNUT-Client trigger workstation shutdown?" 
										 Foreground="{DynamicResource SystemControlForegroundBaseMediumBrush}" 
										 TextWrapping="Wrap" />
					
					<RadioButton Content="When ANY UPS reaches critical state (recommended)" 
											 IsChecked="{Binding ShutdownModeAny}" Margin="0,5,0,0" />
					<RadioButton Content="Only when PRIMARY UPS reaches critical state"
											 IsChecked="{Binding ShutdownModePrimary}" />
					<RadioButton Content="Only when ALL UPS devices reach critical state" 
											 IsChecked="{Binding ShutdownModeAll}" />
				</StackPanel>
			</TabItem>

			<!-- Appearance Tab -->
			<TabItem Header="Appearance">
				<StackPanel Margin="10" Spacing="10">
					<CheckBox Content="Minimize to system tray" IsChecked="{Binding MinimizeToTray}" />
					<CheckBox Content="Start minimized" IsChecked="{Binding MinimizeOnStart}" />
					<CheckBox Content="Close to tray (instead of exit)" IsChecked="{Binding CloseToTray}" />
					<CheckBox Content="Start with Windows" IsChecked="{Binding StartWithWindows}" />
				</StackPanel>
			</TabItem>

			<!-- Shutdown Tab -->
			<TabItem Header="Shutdown">
				<StackPanel Margin="10" Spacing="10">
					<TextBlock Text="Shutdown Conditions" FontWeight="Bold" />
					<Grid ColumnDefinitions="180,*" RowDefinitions="Auto,Auto" RowSpacing="10">
						<TextBlock Grid.Row="0" Grid.Column="0" Text="Battery Charge Limit (%):" VerticalAlignment="Center" />
						<NumericUpDown Grid.Row="0" Grid.Column="1" Value="{Binding ShutdownBatteryLimit}" Minimum="0" Maximum="100" Width="120" HorizontalAlignment="Left" />

						<TextBlock Grid.Row="1" Grid.Column="0" Text="Runtime Limit (seconds):" VerticalAlignment="Center" />
						<NumericUpDown Grid.Row="1" Grid.Column="1" Value="{Binding ShutdownRuntimeLimit}" Minimum="0" Maximum="3600" Width="120" HorizontalAlignment="Left" />
					</Grid>

					<Separator Margin="0,10" />
					<TextBlock Text="Shutdown Action" FontWeight="Bold" />

					<Grid ColumnDefinitions="180,*" RowDefinitions="Auto,Auto" RowSpacing="10">
						<TextBlock Grid.Row="0" Grid.Column="0" Text="Action Type:" VerticalAlignment="Center" />
						<ComboBox Grid.Row="0" Grid.Column="1" SelectedIndex="{Binding ShutdownTypeIndex}" Width="150" HorizontalAlignment="Left">
							<ComboBoxItem Content="Shutdown" />
							<ComboBoxItem Content="Hibernate" />
							<ComboBoxItem Content="Suspend" />
						</ComboBox>

						<TextBlock Grid.Row="1" Grid.Column="0" Text="Delay (seconds):" VerticalAlignment="Center" />
						<NumericUpDown Grid.Row="1" Grid.Column="1" Value="{Binding DelayToShutdown}" Minimum="0" Maximum="300" Width="120" HorizontalAlignment="Left" />
					</Grid>

					<CheckBox Content="Follow NUT server forced shutdown (FSD)" IsChecked="{Binding FollowFsd}" Margin="0,10,0,0" />
					<CheckBox Content="Immediate stop action (no delay)" IsChecked="{Binding ImmediateStopAction}" />
				</StackPanel>
			</TabItem>

			<!-- Calibration Tab -->
			<TabItem Header="Calibration">
				<StackPanel Margin="10" Spacing="10">
					<TextBlock Text="Input Voltage Range" FontWeight="Bold" />
					<Grid ColumnDefinitions="80,120,80,120" RowDefinitions="Auto" ColumnSpacing="10">
						<TextBlock Grid.Column="0" Text="Min:" VerticalAlignment="Center" />
						<NumericUpDown Grid.Column="1" Value="{Binding MinInputVoltage}" Minimum="0" Maximum="500" />
						<TextBlock Grid.Column="2" Text="Max:" VerticalAlignment="Center" />
						<NumericUpDown Grid.Column="3" Value="{Binding MaxInputVoltage}" Minimum="0" Maximum="500" />
					</Grid>

					<TextBlock Text="Output Voltage Range" FontWeight="Bold" Margin="0,10,0,0" />
					<Grid ColumnDefinitions="80,120,80,120" RowDefinitions="Auto" ColumnSpacing="10">
						<TextBlock Grid.Column="0" Text="Min:" VerticalAlignment="Center" />
						<NumericUpDown Grid.Column="1" Value="{Binding MinOutputVoltage}" Minimum="0" Maximum="500" />
						<TextBlock Grid.Column="2" Text="Max:" VerticalAlignment="Center" />
						<NumericUpDown Grid.Column="3" Value="{Binding MaxOutputVoltage}" Minimum="0" Maximum="500" />
					</Grid>

					<TextBlock Text="Load Range (%)" FontWeight="Bold" Margin="0,10,0,0" />
					<Grid ColumnDefinitions="80,120,80,120" RowDefinitions="Auto" ColumnSpacing="10">
						<TextBlock Grid.Column="0" Text="Min:" VerticalAlignment="Center" />
						<NumericUpDown Grid.Column="1" Value="{Binding MinLoad}" Minimum="0" Maximum="100" />
						<TextBlock Grid.Column="2" Text="Max:" VerticalAlignment="Center" />
						<NumericUpDown Grid.Column="3" Value="{Binding MaxLoad}" Minimum="0" Maximum="100" />
					</Grid>

					<TextBlock Text="Frequency" FontWeight="Bold" Margin="0,10,0,0" />
					<ComboBox SelectedIndex="{Binding FrequencyIndex}" Width="100">
						<ComboBoxItem Content="50 Hz" />
						<ComboBoxItem Content="60 Hz" />
					</ComboBox>
				</StackPanel>
			</TabItem>

			<!-- Logging Tab -->
			<TabItem Header="Logging">
				<StackPanel Margin="10" Spacing="10">
					<CheckBox Content="Enable file logging" IsChecked="{Binding EnableFileLogging}" />

					<Grid ColumnDefinitions="80,*" RowDefinitions="Auto" Margin="0,10,0,0">
						<TextBlock Grid.Column="0" Text="Log Level:" VerticalAlignment="Center" />
						<ComboBox Grid.Column="1" SelectedIndex="{Binding LogLevelIndex}" Width="120" HorizontalAlignment="Left">
							<ComboBoxItem Content="Notice" />
							<ComboBoxItem Content="Warning" />
							<ComboBoxItem Content="Error" />
							<ComboBoxItem Content="Debug" />
						</ComboBox>
					</Grid>
				</StackPanel>
			</TabItem>
		</TabControl>
	</DockPanel>
</Window>
